#!/bin/sh
query=`whois $1`
domain=`echo "$query" | grep -i "domain name:" | head -1 | tr [A-Z] [a-z]`
registrar=`echo "$query" | grep -i "registrar:" | head -1 | tr [A-Z] [a-z]`
c_date=`echo "$query" | grep -i "creation date:" | head -1`
u_date=`echo "$query" | grep -i "updated date:" | head -1`
expiry=`echo "$query" | grep -i "expiry\|expiration" | head -1`
not_found=`echo "$query" | grep -i "domain not found" | head -1 | tr [A-Z] [a-z]`
[ "$not_found" = "" ] && {
    domain=${domain//[$'\t\r\n ']}
    registrar=${registrar//[$'\t\r\n ']}
    c_date=${c_date//[$'\t\r\n ']}
    u_date=${u_date//[$'\t\r\n ']}
    expiry=${expiry//[$'\t\r\n ']}
    [ "$(psql -t -c "SELECT * FROM dns.info WHERE domain = '${domain#*:}'")" = "" ] && {
        psql -c "INSERT INTO dns.info
            (domain, registered_at, updated_at, expires_at, registrar)
            VALUES
            ('${domain#*:}', '${c_date#*:}', '${u_date#*:}', '${expiry#*:}', '${registrar#*:}');"
    } || echo "$1 is already tracked!"
} || echo "whois lookup for '$1' returned no record"
